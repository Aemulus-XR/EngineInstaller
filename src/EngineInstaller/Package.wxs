<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

  <!-- Product Definition -->
  <Package
    Name="Unreal Engine 5.6 OculusDrop"
    Manufacturer="Aemulus-XR"
    Version="5.6.0.0"
    UpgradeCode="12345678-1234-1234-1234-123456789012"
    Language="1033"
    Codepage="1252"
    InstallerVersion="500"
    Compressed="yes">

    <SummaryInformation
      Keywords="Installer"
      Description="Unreal Engine 5.6 OculusDrop Edition"
      Manufacturer="Aemulus-XR" />

    <!-- Upgrade logic - upgrade in place -->
    <MajorUpgrade
      DowngradeErrorMessage="A newer version of [ProductName] is already installed."
      AllowSameVersionUpgrades="yes" />

    <!-- Ensure 64-bit Windows -->
    <Launch Condition="VersionNT64" Message="This application requires a 64-bit operating system." />

    <!-- Media definition -->
    <Media Id="1" Cabinet="Engine.cab" EmbedCab="yes" />

    <!-- Installation directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="ManufacturerFolder" Name="Aemulus-XR">
        <Directory Id="INSTALLFOLDER" Name="UE_5.6_OculusDrop">
          <!-- Temp folder for installer resources -->
          <Directory Id="InstallerResourcesFolder" Name=".installer" />
        </Directory>
      </Directory>
    </StandardDirectory>

    <!-- Desktop shortcut -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- Start Menu folder -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="Unreal Engine 5.6" />
    </StandardDirectory>

    <!-- Installer resources component (temporary files) -->
    <Component Id="InstallerResources" Directory="InstallerResourcesFolder" Guid="11111111-1111-1111-1111-111111111111">
      <File Id="SevenZipExe" Source="Resources\7za.exe" KeyPath="yes" />
      <File Id="InstallScript" Source="Resources\Install-Engine.ps1" />
      <File Id="RunInstallBat" Source="Resources\RunInstall.bat" />
      <File Id="DownloadConfigFile" Source="DownloadConfig.json" />

      <!-- Remove this folder after installation -->
      <RemoveFolder Id="RemoveInstallerResources" On="uninstall" />
    </Component>

    <!-- Main application component -->
    <Component Id="EngineRegistration" Directory="INSTALLFOLDER" Guid="87654321-4321-4321-4321-210987654321">

      <!-- Start Menu Shortcut -->
      <Shortcut
        Id="StartMenuShortcut"
        Directory="ApplicationProgramsFolder"
        Name="Unreal Editor 5.6"
        Description="Unreal Engine 5.6 OculusDrop Edition"
        Target="[INSTALLFOLDER]Engine\Binaries\Win64\UnrealEditor.exe"
        WorkingDirectory="INSTALLFOLDER" />

      <!-- Desktop Shortcut -->
      <Shortcut
        Id="DesktopShortcut"
        Directory="DesktopFolder"
        Name="Unreal Editor 5.6"
        Description="Unreal Engine 5.6 OculusDrop Edition"
        Target="[INSTALLFOLDER]Engine\Binaries\Win64\UnrealEditor.exe"
        WorkingDirectory="INSTALLFOLDER" />

      <!-- Required for shortcuts -->
      <RegistryValue
        Root="HKCU"
        Key="Software\Aemulus-XR\UnrealEngine\5.6"
        Name="installed"
        Type="integer"
        Value="1"
        KeyPath="yes" />

      <!-- Installation path registry entry -->
      <RegistryValue
        Root="HKCU"
        Key="Software\Aemulus-XR\UnrealEngine\5.6"
        Name="InstallPath"
        Type="string"
        Value="[INSTALLFOLDER]" />

      <!-- Clean up shortcuts on uninstall -->
      <RemoveFolder Id="RemoveStartMenuFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RemoveFolder Id="RemoveDesktopShortcut" Directory="DesktopFolder" On="uninstall" />

      <!-- Remove installation folder on uninstall -->
      <RemoveFolder Id="RemoveInstallFolder" Directory="INSTALLFOLDER" On="uninstall" />
    </Component>

    <!-- Feature definition -->
    <Feature Id="ProductFeature" Title="Unreal Engine 5.6" Level="1">
      <ComponentRef Id="InstallerResources" />
      <ComponentRef Id="EngineRegistration" />
    </Feature>

    <!-- Custom Action: Set CustomActionData for deferred action -->
    <CustomAction
      Id="SetRunInstallerData"
      Property="RunInstaller"
      Value="&quot;[InstallerResourcesFolder]|[INSTALLFOLDER]&quot;"
      Execute="immediate" />

    <!-- Custom Action: Run installation script via batch file (deferred) -->
    <CustomAction
      Id="RunInstaller"
      Directory="InstallerResourcesFolder"
      ExeCommand='cmd.exe /c "RunInstall.bat [RunInstaller]"'
      Execute="deferred"
      Impersonate="yes"
      Return="check" />

    <!-- Installation sequence -->
    <InstallExecuteSequence>
      <Custom Action="SetRunInstallerData" After="InstallFiles" Condition="NOT Installed" />
      <Custom Action="RunInstaller" After="SetRunInstallerData" Condition="NOT Installed" />
    </InstallExecuteSequence>

    <!-- UI Definition -->
    <ui:WixUI Id="WixUI_InstallDir" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

  </Package>

</Wix>
